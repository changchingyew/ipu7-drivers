From 327c2aded1c4ebf5de3655a95784e3eb608247c3 Mon Sep 17 00:00:00 2001
From: Khai Wen Ng <khai.wen.ng@intel.com>
Date: Thu, 28 Aug 2025 14:46:45 +0800
Subject: [PATCH 45/61] i2c: atr: Add fwnode handling

fwnode does not support i2c-atr nodes structure.
points to parent fwnode instead.

Signed-off-by: Khai Wen Ng <khai.wen.ng@intel.com>
---
 drivers/i2c/i2c-atr.c | 26 ++++++++++++++++----------
 1 file changed, 16 insertions(+), 10 deletions(-)

diff --git a/drivers/i2c/i2c-atr.c b/drivers/i2c/i2c-atr.c
index dd194476b1184..fdd6782ee600d 100644
--- a/drivers/i2c/i2c-atr.c
+++ b/drivers/i2c/i2c-atr.c
@@ -834,17 +834,23 @@ int i2c_atr_add_adapter(struct i2c_atr *atr, struct i2c_atr_adap_desc *desc)
 		u32 reg;
 
 		atr_node = device_get_named_child_node(dev, "i2c-atr");
-
-		fwnode_for_each_child_node(atr_node, child) {
-			ret = fwnode_property_read_u32(child, "reg", &reg);
-			if (ret)
-				continue;
-			if (chan_id == reg)
-				break;
+		if (atr_node) {
+
+			fwnode_for_each_child_node(atr_node, child) {
+				ret = fwnode_property_read_u32(child, "reg", &reg);
+				if (ret)
+					continue;
+				if (chan_id == reg)
+					break;
+			}
+
+			device_set_node(&chan->adap.dev, child);
+			fwnode_handle_put(atr_node);
+		}
+		else {
+			if (dev_fwnode(dev))
+				device_set_node(&chan->adap.dev, fwnode_handle_get(dev_fwnode(dev)));
 		}
-
-		device_set_node(&chan->adap.dev, child);
-		fwnode_handle_put(atr_node);
 	}
 
 	if (desc->num_aliases > 0) {
-- 
2.50.1

